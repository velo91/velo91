server {
  listen 80;
  server_name ojs.mysite.com;
  {{root}}
  index index.php index.html;
  location / { return 301 https://$host$request_uri; }
}

server {
  listen 443 ssl http2;
  #{{ssl_certificate_key}}
  #{{ssl_certificate}}
  ssl_stapling off;
  ssl_stapling_verify off;
  ssl_certificate_key /root/.acme.sh/ojs.mysite.com/ojs.mysite.com.key;
  ssl_certificate /root/.acme.sh/ojs.mysite.com/fullchain.cer;
  ssl_dhparam /etc/nginx/ssl/dhparams.pem;
  server_name ojs.mysite.com;
  {{root}}
  index index.php index.html;

  add_header X-Content-Type-Options "nosniff";
  add_header X-XSS-Protection "1; mode=block";
  add_header X-Frame-Options "SAMEORIGIN";

  {{nginx_access_log}}
  {{nginx_error_log}}

  # allow ACME challenge
  location ~ /.well-known {
    allow all;
  }

  {{settings}}

  autoindex off;

  location / {
    try_files $uri $uri/ /index.php$query_string;
  }

  location = /config.inc.php {
    return 403;
  }

  # main OJS handler
  location ~ ^/index.php($|/) {
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass 127.0.0.1:{{php_fpm_port}};
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_intercept_errors on;
    fastcgi_index index.php;
    fastcgi_read_timeout 3600;
    fastcgi_send_timeout 3600;
    fastcgi_param HTTPS "on";
    fastcgi_param SERVER_PORT 443;
    fastcgi_param PHP_VALUE "{{php_settings}}";
  }

  # NOTE:
  # on installation, you must use MySQLi as database driver

  # static assets
  location ~* \.(css|js|xml|jpg|jpeg|gif|png|ico|swf|pdf|doc|xls|tiff|txt|htm|html|woff|woff2|ttf|svg)$ {
    access_log off;
    expires 30d;
    try_files $uri =404;
  }

  # deny access ke file dot (misal .htaccess, .git)
  location ~ /\. {
    deny all;
  }
}
