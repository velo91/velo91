user root;
worker_processes auto;
pid /run/nginx.pid;
worker_rlimit_nofile 8192;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 20000;
    # multi_accept on;
    use epoll; # Tambahkan jika pakai Linux agar performa lebih baik
    multi_accept on; # Agar worker menerima banyak koneksi sekaligus
}

http {
    resolver 1.1.1.1 8.8.8.8 valid=300s;

    ##
    # Basic Settings
    ##

    server_names_hash_bucket_size 256;
    server_names_hash_max_size 1024;
    variables_hash_max_size 2048;
    variables_hash_bucket_size 128;

    geoip_country /etc/nginx/geoip/GeoIP.dat; # the country IP database
    geoip_city    /etc/nginx/geoip/GeoLiteCity.dat; # the city IP database

    real_ip_recursive on;

    set_real_ip_from 127.0.0.1;
    set_real_ip_from 10.0.0.0/8;
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    set_real_ip_from 0.0.0.0/0;
    real_ip_header X-Forwarded-For;

    log_format main '$time_iso8601 $server_name $remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    log_format cloudflare '$time_iso8601 $server_name $http_cf_connecting_ip - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    client_body_buffer_size 128K; # awalnya 1K
    client_header_buffer_size 1K;
    client_max_body_size 60M; # ada camaba rpl yang harus upload file sk/sertifikat hingga 60 mb
    client_body_timeout 120;
    client_header_timeout 60; # tambahan
    keepalive_timeout 65;
    send_timeout 600;
    proxy_connect_timeout 600; # tambahan Optional untuk Cloudflare
    proxy_send_timeout 600; # tambahan Optional untuk Cloudflare
    proxy_read_timeout 600; # tambahan Optional untuk Cloudflare
    types_hash_max_size 2048;
    server_tokens off;
    port_in_redirect off;
    access_log off;

    map $scheme $fastcgi_https { ## Detect when HTTPS is used
      default off;
      https on;
    }

    include /etc/nginx/blocked_ips;

    pagespeed off;
    pagespeed XHeaderValue 1;

    ##
    # Security Settings
    ##

    #add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains; preload';
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    #add_header Content-Security-Policy "img-src 'self' data:;";
    add_header X-Permitted-Cross-Domain-Policies master-only;
    add_header Referrer-Policy same-origin;
    #add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), camera=(), encrypted-media=(), fullscreen=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), sync-xhr=(self 'https://haveibeenpwned.com/' 'https://twofactorauth.org/%27), usb=(), vr=()";

    ##
    # SSL Settings
    ##

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache builtin:1000 shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_ciphers EECDH+AESGCM:EDH+AESGCM;
    ssl_prefer_server_ciphers on;
    #ssl_stapling on;
    ssl_stapling off;
    #ssl_stapling_verify on;
    ssl_stapling_verify off;
    ssl_dhparam /etc/nginx/ssl/dhparams.pem;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # Logging Settings
    ##
    # 1. Tentukan apakah permintaan harus diabaikan berdasarkan URI (URL)
    map $request_uri $ignore_by_uri {
        default 0;  # Secara default, jangan diabaikan
        ~^/assets/avatar/ 1;  # Abaikan jika URI dimulai dengan /assets/avatar/ karena ada fitur selectbox yang menampilkan semua avatar dosen baik found maupun not found yang dibantu oleh onerror
        ~^/course/info\.php(\?.*)?$ 1; # Abaikan semua /course/info.php dengan parameter apapun karena ada course yang sudah diarsipkan tapi masih diindex oleh bot mesin pencari
    }
    # 2. Tentukan apakah permintaan harus diabaikan berdasarkan status kode
    map $status $ignore_by_status {
        ~^[23] 1;   # Abaikan semua status 2xx dan 3xx
        499 1;      # Abaikan status 499 (Client Closed Request)
        default 0;  # Catat status lainnya (termasuk 404, 5xx, dll.)
    }
    # 3. Gabungkan kedua kondisi untuk menentukan apakah log harus dicatat
    # Log akan dicatat HANYA JIKA $ignore_by_uri = 0 (jangan diabaikan)
    # DAN $ignore_by_status = 0 (jangan diabaikan)
    map "$ignore_by_uri$ignore_by_status" $loggable {
        "00" 1;  # Catat hanya jika keduanya 0
        default 0; # Abaikan sisanya
    }
    access_log /var/log/nginx/access.log main if=$loggable;
    error_log /var/log/nginx/error.log;

    ##
    # Limit the requests for php
    ##
    #limit_req_zone $binary_remote_addr zone=limit:10m rate=1r/s;
    #
    # zone=limit:100m: Nama zona 'limit' dengan alokasi 100MB memori. Ini lebih dari cukup untuk melacak 3000 IP unik (bahkan lebih).
    #
    # rate=50r/s: Batasan 50 permintaan per detik PER IP. Nilai ini sudah cukup longgar untuk aktivitas normal Browse dan aplikasi web.
    #
    limit_req_zone $binary_remote_addr zone=limit:100m rate=50r/s;

    ##
    # Gzip Settings
    ##

    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 8;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript image/png image/gif image/jpeg application/javascript image/svg+xml;

    ##
    # Brotli Settings
    ##

    brotli on;
    brotli_comp_level 8;
    brotli_static on;
    brotli_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript image/png image/gif image/jpeg application/javascript image/svg+xml;

    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/sites-enabled/*.conf;
}
